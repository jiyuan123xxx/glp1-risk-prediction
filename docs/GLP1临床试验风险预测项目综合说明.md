# GLP-1临床试验风险预测项目综合说明

## 📋 项目概述

### 🎯 项目目标
GLP-1临床试验风险预测项目旨在开发一个基于机器学习的数据驱动系统，用于预测GLP-1类药物临床试验的成功风险。项目通过分析临床试验数据，识别高风险试验，为药物研发决策提供科学依据。

### 🔬 科学背景
GLP-1（胰高血糖素样肽-1）受体激动剂是治疗2型糖尿病和肥胖的重要药物类别。临床试验的成功率直接影响药物研发成本和上市时间。本项目通过数据挖掘和机器学习技术，探索临床试验风险的预测模式。

### 📊 数据基础（优化后）
- **数据来源**: AACT（Aggregate Analysis of ClinicalTrials.gov）数据库
- **数据规模**: 22,093个GLP-1相关临床试验记录（从568,538个精简）
- **核心文件**: studies.txt、conditions.txt、eligibilities.txt
- **数据质量**: 整体质量良好，关键字段填充率高
- **数据优化**: 原始数据从1.28GB减少到44.5MB（缩减96.5%）

---

## 🏗️ 系统架构

### 📁 项目目录结构
```
glp1-risk-prediction/
├── data/                    # 数据管理
│   ├── raw/                 # 原始数据（不可修改）
│   │   ├── studies.txt      # 临床试验基本信息
│   │   ├── conditions.txt   # 试验条件信息
│   │   └── eligibilities.txt # 入排标准信息
│   ├── processed/          # 处理后的数据
│   │   ├── preprocessed_data.csv
│   │   ├── glp1_18clinical_features.csv
│   │   └── glp1_18clinical_features_with_labels_correct.csv
│   └── external/           # 外部数据源（预留）
├── scripts/                 # 核心处理脚本
│   ├── analysis/           # 分析工具脚本
│   │   ├── analyze_conditions.py      # 适应症分布分析
│   │   ├── analyze_label_options.py   # 标签方案可行性分析
│   │   ├── analyze_studies_status.py  # 试验状态分析
│   │   ├── analyze_time_split.py      # 时间分割分析
│   │   └── test_ensemble.py           # 集成学习测试
│   ├── 01_数据预处理.py     # 数据加载和清洗
│   ├── 02_特征工程.py       # 18个风险特征构建
│   ├── 03_特征分析与可视化.py # 特征探索分析
│   ├── 04_标签定义_正确方法.py # 风险标签定义
│   ├── 05_集成学习.py       # 模型训练和评估
│   └── 06_仪表盘_改进版.py  # 可视化仪表板
├── docs/                    # 项目文档
├── results/                 # 输出结果
│   ├── models/             # 训练好的模型文件
│   ├── visualizations/     # 可视化图表
│   └── reports/            # 分析报告
├── notebooks/               # Jupyter笔记本
├── assets/                  # 静态资源（预留）
├── requirements.txt         # Python依赖包
├── README.md               # 项目说明
├── .gitignore              # Git忽略文件
└── LICENSE                 # 开源许可证
```

### 🔄 数据处理流程

#### 1. 数据预处理 (`01_数据预处理.py`)
- **输入**: 原始TXT文件 (studies.txt, conditions.txt, eligibilities.txt)
- **处理**: 数据清洗、缺失值处理、格式转换
- **输出**: 结构化的CSV文件

#### 2. 特征工程 (`02_特征工程.py`)
- **输入**: 预处理后的数据
- **处理**: 构建18个临床风险特征
- **输出**: 特征矩阵CSV文件

#### 3. 标签定义 (`04_标签定义_正确方法.py`)
- **输入**: 特征矩阵
- **处理**: 基于真实试验结果定义风险标签
- **输出**: 带标签的特征数据集

#### 4. 模型训练 (`05_集成学习.py`)
- **输入**: 带标签的特征数据
- **处理**: 集成学习模型训练和评估
- **输出**: 训练好的模型和性能报告

#### 5. 可视化分析 (`06_仪表盘_改进版.py`)
- **输入**: 模型和测试数据
- **处理**: 生成性能仪表板和可解释性分析
- **输出**: 可视化图表和HTML报告

---

## 📊 特征工程详解

### 🎯 18个临床风险特征

#### 1. 试验规模与统计效力特征
- **`enrollment_log`**: 注册人数对数变换（试验规模与统计效力特征）
  - 计算方式: `log(enrollment + 1)`
  - 临床意义: 试验规模越大，统计效力越强，但组织复杂度也越高

#### 2. 药物研发时代与里程碑特征
- **`start_year`**: 试验开始年份（药物研发时代与里程碑特征）
- **`pre_semaglutide_era`**: 司美格鲁肽上市前时代（如果开始年份 < 2017则为1）
- **`post_semaglutide_era`**: 司美格鲁肽上市后时代（如果开始年份 >= 2017则为1）

#### 3. 试验阶段与监管风险特征
- **`phase_Unknown`**: 试验阶段未知（如果试验阶段信息缺失则为1）
- **`phase_PHASE4`**: IV期上市后研究（如果试验阶段为IV期则为1）

#### 4. 适应症与目标人群风险特征
- **`is_obesity`**: 肥胖相关试验（如果适应症包含肥胖相关术语则为1）
- **`is_t2d`**: 2型糖尿病试验（如果适应症包含2型糖尿病相关术语则为1）
- **`is_weight_loss`**: 减重为主要终点的试验（如果主要终点包含体重减轻相关术语则为1）

#### 5. 入排标准与患者选择特征
- **`exc_count`**: 排除标准数量（入排标准文本中排除条款的数量统计）
- **`criteria_total_len`**: 入排标准总字符数（入排标准文本的总长度）

#### 6. 安全性文本信号强度特征
- **`mentions_bmi`**: 提及BMI（如果文本包含BMI相关术语则为1）
- **`mentions_contraindication`**: 提及禁忌症（如果文本包含禁忌症相关术语则为1）
- **`mentions_renal_cutoff`**: 提及肾功能阈值（如果文本包含肾功能阈值相关术语则为1）
- **`high_risk_term_count`**: 高风险术语计数（高风险医学术语在文本中的出现次数）
- **`risk_ratio`**: 风险比率（高风险术语数量与总术语数量的比率）

#### 7. 交互特征
- **`year_x_enrollment`**: 年份 × 注册人数对数（`start_year * enrollment_log`）
- **`enrollment_log_x_phase_Unknown`**: 注册人数对数 × 阶段未知（`enrollment_log * phase_Unknown`）

### 🔧 特征工程技术
- **文本处理**: 使用正则表达式进行术语匹配
- **数值转换**: 对数变换处理偏态分布
- **缺失值处理**: 分类特征缺失作为单独类别，数值特征使用中位数填充

---

## 🤖 模型架构与性能

### 🎯 模型设计目标
1. **高召回率**: 尽可能检测出高风险临床试验
2. **可解释性**: 提供清晰的决策依据和特征重要性
3. **稳健性**: 在不同数据分布下保持稳定性能
4. **实用性**: 支持实际部署和持续更新

### 🔧 集成学习框架

#### 基础模型
- **逻辑回归 (Logistic Regression)**: 可解释性强，计算效率高
- **随机森林 (Random Forest)**: 抗过拟合，处理非线性关系
- **XGBoost**: 高性能，优秀的泛化能力

#### 集成策略
- **加权集成**: 根据验证集性能分配权重
- **堆栈集成**: 使用基础模型的预测作为元特征

### 类别不平衡处理
- **SMOTE过采样**: 生成合成的高风险样本
- **代价敏感学习**: 高风险样本权重更高

### 📊 模型性能指标

| 指标 | 随机分割 | 时间分割 | 说明 |
|------|----------|----------|------|
| AUC | 0.6453 | 0.6348 | 中等区分能力 |
| 召回率 | 0.4000 | 0.4286 | 检测40%高风险试验 |
| 精确率 | 0.0056 | 0.0024 | 受极端不平衡影响 |
| F1分数 | 0.0111 | 0.0047 | 综合性能指标 |

### 🔍 可解释性分析
- **SHAP分析**: 全局特征重要性识别
- **LIME分析**: 局部样本预测解释
- **PDP分析**: 特征边际效应分析

---

## 📈 数据分析报告

### 📊 数据分析报告（优化后）

### 📊 数据基础分析（GLP-1相关临床试验）

#### 试验状态分布分析
- **总试验数量**: 22,093个GLP-1相关临床试验
- **overall_status字段填充率**: 100.00%（完美填充）
- **why_stopped字段填充率**: 6.38%（相对较低）

#### 风险状态分类
- **高风险状态** (TERMINATED, WITHDRAWN, SUSPENDED): **1,597个 (7.23%)**
  - TERMINATED (终止): 1,597个 (100%)
- **低风险状态**: 20,496个 (92.77%)

#### 终止原因分析
- **有why_stopped信息的试验数**: 1,597个
- **终止状态试验的why_stopped填充率**: 100.00%（完美填充）
- **主要终止原因**:
  - 安全性问题: 基于安全性关键词识别的高风险试验
  - 入组问题: 试验组织和管理问题
  - 其他原因: 药物配方、随机化错误等

### 🔬 标签定义方案可行性分析（GLP-1相关临床试验）

#### 方案A: 扩展安全性关键词列表
- **当前关键词召回率**: 基于安全性关键词识别高风险试验
- **效果评估**: 针对GLP-1相关试验优化，效果良好

#### 方案B: 处理缺失why_stopped的终止试验
- **样本损失**: 无样本损失，所有终止试验都有why_stopped信息
- **数据质量**: 高质量，why_stopped字段填充率100%
- **效果评估**: 数据质量优良，无需额外处理

#### 推荐方案: 基于真实试验结果定义风险标签
- **理由**: 使用真实的试验终止状态和安全性信息定义风险标签
- **高风险试验**: 73个（基于终止状态和安全性关键词）
- **低风险试验**: 18,240个
- **标签分布**: 高风险0.40%，低风险99.60%

### ⏰ 时间分割分析

#### 时间分割策略
- **训练集**: 2021年及以前的试验
- **测试集**: 2021年以后的试验
- **现实性**: 更符合实际部署场景

#### 性能对比
- **时间分割**: 更严格的测试，性能略低但更真实
- **随机分割**: 性能较高但可能过拟合历史模式

---

## 🔧 分析脚本功能

### 📊 分析脚本列表

#### 1. `analyze_conditions.py` - 适应症分布分析
- **功能**: 分析临床试验适应症分布
- **输出**: 疾病条件词频统计、主要适应症类别分布

#### 2. `analyze_studies_status.py` - 试验状态分析
- **功能**: 分析overall_status和why_stopped字段
- **输出**: 状态分布可视化、风险状态分布图

#### 3. `analyze_label_options.py` - 标签方案可行性分析
- **功能**: 分析不同标签定义方案的可行性
- **输出**: 召回率对比、关键词优化建议

#### 4. `analyze_time_split.py` - 时间分割分析
- **功能**: 分析按时间分割训练集和测试集的效果
- **输出**: 时间分布可视化、分割策略性能对比

#### 5. `test_ensemble.py` - 集成学习测试
- **功能**: 简化版集成学习测试脚本
- **输出**: 数据加载验证、基础模型性能测试

### 🚀 使用指南

```bash
# 运行适应症分析
python scripts/analysis/analyze_conditions.py

# 运行试验状态分析
python scripts/analysis/analyze_studies_status.py

# 运行标签方案分析
python scripts/analysis/analyze_label_options.py

# 运行时间分割分析
python scripts/analysis/analyze_time_split.py

# 运行集成学习测试
python scripts/analysis/test_ensemble.py
```

---

## 📊 项目状态与成果

### 🏗️ 架构实现状态
- **数据层**: ✅ 已完成 - 原始数据和处理数据完整
- **处理层**: ✅ 已完成 - 6个核心处理脚本就绪
- **模型层**: ✅ 已完成 - 集成学习模型训练完成
- **展示层**: ✅ 已完成 - 可视化仪表板就绪
- **文档层**: ✅ 已完成 - 完整文档和说明

### 📁 当前文件统计（优化后）
- **数据文件**: 11个 (44.5MB 原始数据 + 35.4MB 处理数据)
- **脚本文件**: 11个 (总计 128KB)
- **Notebook文件**: 6个 (总计 190KB)
- **文档文件**: 7个 (总计 41KB)
- **结果文件**: 18个 (总计 8.5MB)
- **项目总计**: 约79.9MB（从约1.36GB缩减94.2%）

### 🎯 技术栈验证
- **Python环境**: ✅ 虚拟环境已配置
- **依赖包**: ✅ 29个核心包已安装
- **Notebook语法**: ✅ 所有notebook语法正确
- **数据完整性**: ✅ 关键数据文件完整

---

## 🔮 未来发展方向

### 技术演进
- **自监督学习**: 利用无标签数据提升性能
- **图神经网络**: 建模临床试验之间的复杂关系
- **多模态学习**: 整合文本、图像等多源数据

### 应用扩展
- **个性化风险评估**: 针对特定药物或适应症
- **实时风险监控**: 动态更新风险预测
- **决策支持系统**: 集成到药物研发流程中

### 性能优化
- **阈值优化**: 根据业务需求调整分类阈值
- **特征选择**: 移除冗余或噪声特征
- **集成策略调整**: 优化模型权重分配

---

## 💡 关键洞察与建议

### 科学价值
1. **数据驱动决策**: 为GLP-1临床试验风险预测提供科学依据
2. **特征工程创新**: 18个临床驱动的风险特征设计
3. **可解释性分析**: 提供透明的决策支持

### 实施建议
1. **保持当前标签定义**: 基于真实试验结果的风险定义是科学的
2. **优化特征工程**: 基于实际数据持续优化特征设计
3. **处理类别不平衡**: 采用SMOTE等技术处理8.86%的高风险比例

### 风险管理
1. **数据质量监控**: 持续监控关键字段的填充率
2. **模型性能评估**: 重点关注高风险试验的识别能力
3. **外部验证**: 在独立数据集上验证模型泛化能力

---

## 📝 附录

### A. 技术依赖
- **Python版本**: 3.10+
- **核心依赖包**: scikit-learn, pandas, numpy, matplotlib, seaborn, shap, lime
- **环境配置**: 虚拟环境 + requirements.txt

### B. 数据文件说明
- **原始数据**: data/raw/ 目录下的TXT文件
- **处理数据**: data/processed/ 目录下的CSV文件
- **分析结果**: results/ 目录下的图表和报告

### C. 运行说明
1. 配置Python虚拟环境
2. 安装依赖包: `pip install -r requirements.txt`
3. 按顺序运行核心处理脚本
4. 查看分析结果和可视化报告

---

**文档生成时间**: 2026-02-27  
**项目版本**: v1.0  
**更新周期**: 每月更新  
**维护人员**: 系统管理员  

---

*本文档整合了项目所有核心文档内容，包括架构说明、特征工程、模型设计、数据分析报告和分析脚本说明，为项目提供了全面的技术参考和操作指南。*